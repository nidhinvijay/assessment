{% extends 'base.html' %}
{% block title %}{{ poll.title }} - Results{% endblock %}

{% block content %}
<div class="glass-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ poll.title }} - Results</h1>
        <a href="{% url 'export_results_csv' poll.id %}" class="btn btn-secondary">Export to CSV</a>
    </div>

    {% for question, data in results.items %}
    <div class="mb-5">
        <h3>{{ question.question_text }}</h3>
        <p class="text-muted">Total votes: {{ data.total_votes }}</p>
        <div class="row align-items-center">
            <div class="col-md-7">
                {% for choice in data.choices %}
                <div>
                    <strong>{{ choice.choice_text }}:</strong> {{ choice.vote_count }} vote(s)
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ choice.percentage|floatformat:2 }}%;"
                             aria-valuenow="{{ choice.percentage|floatformat:2 }}" 
                             aria-valuemin="0" aria-valuemax="100">
                             
                             {% if choice.percentage > 0 %}
                                 {{ choice.percentage|floatformat:1 }}%
                             {% endif %}
                        </div>
                    </div>
                </div>
                <br>
                {% endfor %}
            </div>
            <div class="col-md-5">
                <canvas id="chart{{ question.id }}"></canvas>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ctx{{ question.id }} = document.getElementById('chart{{ question.id }}').getContext('2d');
            new Chart(ctx{{ question.id }}, {
                type: 'doughnut',
                data: {
                    labels: [{% for choice in data.choices %}'{{ choice.choice_text }}',{% endfor %}],
                    datasets: [{
                        data: [{% for choice in data.choices %}{{ choice.vote_count }},{% endfor %}],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                        borderColor: 'var(--card-bg)',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'var(--text-color)'
                            }
                        }
                    }
                }
            });
        });
    </script>
    {% endfor %}
</div>
{% endblock %}